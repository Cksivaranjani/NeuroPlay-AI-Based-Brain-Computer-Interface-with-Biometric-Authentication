<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Maze Game</title>
  <link href="https://fonts.googleapis.com/css2?family=Audiowide&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(to right, #e1e1e2, #bef1ff);
      color: #333;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(to right, #0f4c81, #34c2d6);
      padding: 10px 30px;
      border-bottom: 2px solid #000;
    }
    .logo {
      display: flex;
      align-items: center;
    }
    .logo img {
      width: 40px;
      height: 40px;
      margin-right: 10px;
    }
    .logo span {
      font-size: 24px;
      font-weight: bold;
      color: white;
      font-family: 'Audiowide', cursive;
    }
    nav a {
      background-color: white;
      color: black;
      padding: 8px 15px;
      margin-left: 15px;
      border-radius: 8px;
      text-decoration: none;
      font-weight: bold;
      transition: background 0.3s;
    }
    nav a:hover {
      background-color: #ddd;
    }

.game-container {
  display: flex;
  height: 91vh; /* Full viewport height */
  overflow: hidden;
}

.sidebar {
  width: 350px;
  height: 100%; /* Full height */
  background: #ffffff;
  border-right: 2px solid #ddd;
  box-shadow: 2px 0 6px rgba(0, 0, 0, 0.1);
  padding: 28px;
  box-sizing: border-box;
  display: flex;
  flex-direction: column;
}

.sidebar .sectionrow {
  display: flex;
  justify-content: space-between;
  gap: 30px;
  margin-bottom: 30px;
}

.sidebar button {
  flex: 1;
  padding: 10px;
  border: none;
  border-radius: 8px;
  background: rgb(15, 88, 189);
  color: white;
  font-weight: bold;
  cursor: pointer;
  transition: background 0.3s ease;
}
.sidebar .help{
    background: limegreen;
    color: white;
}
.sidebar button:hover {
  background: rgb(52, 104, 177);
}
.sidebar .help:hover{
    background: rgb(89, 233, 89);
    color: white;
}
.sidebar .buy{
    background: rgb(252, 218, 25);
    padding: 10px;
    margin-bottom: 25px;
    width: 100%;
    text-align: center;
} 
.sidebar .buy:hover{
  background: rgb(247, 220, 70) ;
}
.stats-group {
  display: flex;
  flex-direction: column;
  gap: 8px; 
}
.timer {
  line-height: 2;
  font-weight: bold;
}
.timer-bar {
  height: 10px;
  background-color: #eee;
  border-radius: 5px;
  overflow: hidden;
  margin: 6px 0 10px;
}

#timer-fill {
  height: 100%;
  width: 100%;
  background-color: limegreen;
  transition: width 1s linear, background-color 0.3s ease;
}
.score{
    margin: 0px 10px;
    font-weight: bold;
    text-align: center;
    font-size: 20px;
    padding: 10px;
    border-radius: 10px;
    background-color: rgb(255, 128, 0);
}
.shieldsec{
    font-weight: bold;
    margin-top: 10px;
    margin-bottom: 10px;
}
.section .diff{
    font-weight: bold;
}
.section select {
  margin-top: 15px;
  width: 100%;
  padding: 10px;
  border-radius: 6px;
  border: 1px solid #ccc;
  margin-bottom: 25px;
  background: red;
}

.section select option{
    background: white;
    color: black;
}

.leaderboard h2 {
  font-weight: bold;
  font-size: 18px;
  margin-bottom: 18px;
}

.playerlead {
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 3px;
  border-radius: 25px;
  margin-bottom: 10px;
  border: 2px solid rgb(152, 151, 151);
  box-shadow: #444;
  font-weight: bold;
  gap: 8%;
  background: #00abc2;
  transition: all 0.3s ease;
}
.playerlead img {
  width: 40px;
  height: 40px;
  vertical-align: middle;
  margin-right: 10px;
  border-radius: 50%;
  border: 2px solid white;
}

.playerlead span {
  font-size: 17px;
  color: #252525;
}


    .maze-display {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
      overflow: auto;
    }

    .maze-grid {
      display: grid;
      grid-template-columns: repeat(14, 40px);
      grid-template-rows: repeat(14, 40px);
      gap: 2px;
    }

    .cell {
      width: 40px;
      height: 40px;
      border: 1px solid #999;
      background-color: white;
      transition: all 0.2s ease;
    }

    .wall {
      background-color: black;
    }

    @keyframes bounce {
      0% { transform: scale(1); }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }

    .goal {
      background-color: rgb(0, 255, 34);
    }
    .player{
        background-color: rgb(60, 188, 238);
        animation: bounce 0.2s;
    }

    button, select {
     width: 100%;
      padding: 12px;
      background: linear-gradient(to right, #0072ff, #00c6ff);
      border: none;
      color: white;
      font-weight: bold;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
    }

    button:hover {
      background: linear-gradient(to right, #005fce, #00acc1);
    }

    .obstacle {
      background-color: rgb(255, 0, 0);
    }

    .shield {
  background-color: gold;
  border: 2px solid #fff;
}

.icon-button {
            font-size: 15px;
            padding: 10px;
            margin: 10px;
            cursor: pointer;
            border: none;
            background-color: #ffffff;
            border-radius: 50px;
        }
        .reload .icon-button{
          background-color: #590de6;
          color: white;
          font-size: 20px;
          font-weight: bold;
          padding-left: 12px;
          padding-right: 12px;
        }
        
        .icon-button:hover {
            background-color: #c2c2c2;
        }
        .reload .icon-button:hover {
            background-color: #9263e9;
        }
      .stats-group .reload{
        width: 300px;
        height: 62px;
      }
.stats-group .reload{
  display: flex;
  justify-content: space-between;
  gap: 3px;
}
.stats-group .reload .score{
  width: 100%;
  height: 80%;
  padding-top: 13px;
}

  </style>
</head>
<body>
  <header>
    <div class="logo">
      <img src="{{ url_for('static', filename='images/brain.png') }}" alt="Brain Logo" />
      <span>NEUROPLAY</span>
    </div>
    <nav>
      <a href="{{ url_for('home') }}">Home</a>
      <a href="{{ url_for('dashboard') }}">Dashboard</a>
      <a href="{{ url_for('about') }}">About us</a>
      <a href="{{ url_for('contact') }}">Contact us</a>
    </nav>
  </header>

  <div id="flash-data" data-message="{{ get_flashed_messages()[0] if get_flashed_messages() else '' }}"></div>

  <div class="game-container">
    <div class="sidebar">
      <div class="stats-group">
        <div class="reload"><div class="score">Score: <span id="score">0</span></div>
        <span class="icon-button" onclick="reloadPage()">&#x21bb;</span></div>
        <div class="timer">Timer: <span id="timer">50</span> sec</div>
        <div class="timer-bar">
            <div id="timer-fill"></div>
          </div>
        <div class="shieldsec">Shields: <span id="shields">1</span></div>
        <div class="section">
            <button onclick="buyShield()" class="buy">üõ°Ô∏è Buy Shield (-20 points)</button>
            </div>
      </div>
      <div class="section">
        <label for="difficulty" class="diff">Difficulty Level:</label>
        <select id="difficulty">
            <option value="easy">Easy</option>
            <option value="medium" selected>Medium</option>
            <option value="hard">Hard</option>
          </select>
      </div>
      <div class="sectionrow">
        <button onclick="startGame()">‚ñ∂Ô∏è Play</button>
        <button onclick="showHelp()" class="help">‚ùì Help</button>
      </div>
      <div class="leaderboard">
        <h2>Leaderboard</h2>
        <div class="playerlead">
          <img src="{{ url_for('static', filename='images/gold.png') }}" alt="P1">
          <span>Neuroplayer - 120</span>
        </div>
      </div>
    </div>

    <div class="maze-display">
      <div class="maze-grid" id="maze"></div>
      <span class="icon-button" onclick="goToDashboard()">&#x274C;</span>
    </div>
  </div>

  <script>
let maze = document.getElementById('maze');
let playerPos = { x: 1, y: 1 };
let score = 0;
let shields = 1;
let timerInterval;
let timeLeft = 50;
let mazeData = [];
let movesQueue = [];
let currentMoveIndex = 0;
    
    let moveSound, winSound, wallSound;
    
    function initSounds() {
      moveSound = new Audio("{{ url_for('static', filename='sounds/move.mp3') }}");
      winSound = new Audio("{{ url_for('static', filename='sounds/shield.mp3') }}");
      wallSound = new Audio("{{ url_for('static', filename='sounds/wall.wav') }}");
      timerSound = new Audio("{{ url_for('static', filename='sounds/timer.mp3') }}");
      shieldsound = new Audio("{{ url_for('static', filename='sounds/win.mp3') }}")
    }
    
    const easyMaze = [ 
  [1,1,1,1,1,1,1,1,1,1,1,1,1,1],
  [1,0,0,0,1,0,0,0,0,1,0,0,0,1],
  [1,0,1,0,1,0,1,1,0,1,0,1,0,1],
  [1,0,1,0,0,0,0,1,0,1,0,1,0,1],
  [1,0,1,1,1,1,0,1,0,1,0,1,0,1],
  [1,0,0,4,0,1,0,1,0,1,0,0,0,1],
  [1,1,1,1,0,0,0,1,0,1,1,1,0,1],
  [1,0,0,1,0,0,0,0,0,0,0,1,0,1],
  [1,0,1,1,1,1,1,1,0,1,0,1,0,1],
  [1,0,0,0,0,0,0,1,0,1,0,1,0,1],
  [1,0,1,1,1,1,0,1,0,1,0,1,0,1],
  [1,0,0,0,0,1,0,0,0,1,0,1,0,1],
  [1,1,1,1,0,1,1,1,1,1,0,2,0,1],
  [1,1,1,1,1,1,1,1,1,1,1,1,1,1]
];

    
const mediumMaze = [ 
  [1,1,1,1,1,1,1,1,1,1,1,1,1,1],
  [1,0,0,3,1,0,0,0,0,1,0,0,0,1],
  [1,0,1,0,1,3,1,1,0,1,0,1,0,1],
  [1,0,1,0,0,0,0,1,3,1,0,1,0,1],
  [1,0,1,1,1,1,0,1,0,1,0,1,0,1],
  [1,0,0,4,0,1,0,1,0,1,0,0,0,1],
  [1,1,1,1,0,3,0,1,0,1,1,1,0,1],
  [1,0,0,1,0,0,0,0,0,0,0,1,0,1],
  [1,0,1,1,1,1,1,1,0,1,0,1,0,1],
  [1,0,0,0,0,0,0,1,0,1,0,1,0,1],
  [1,0,1,1,1,1,0,1,0,1,0,1,0,1],
  [1,0,0,0,0,1,0,0,0,1,0,1,0,1],
  [1,1,1,1,0,1,1,1,1,1,0,2,0,1],
  [1,1,1,1,1,1,1,1,1,1,1,1,1,1]
];

const hardMaze = [ 
  [1,1,1,1,1,1,1,1,1,1,1,1,1,1],
  [1,0,3,0,1,0,3,0,0,1,0,3,0,1],
  [1,0,1,0,1,3,1,1,3,1,0,1,0,1],
  [1,3,1,0,0,0,0,1,3,1,0,1,0,1],
  [1,0,1,1,1,1,0,1,0,1,0,1,0,1],
  [1,0,3,4,0,1,3,1,0,1,0,0,0,1],
  [1,1,1,1,0,3,0,1,0,1,1,1,0,1],
  [1,0,0,1,0,0,0,0,0,0,0,1,0,1],
  [1,0,1,1,1,1,1,1,0,1,0,1,0,1],
  [1,0,0,0,0,0,0,1,0,1,0,1,0,1],
  [1,0,1,1,1,1,0,1,0,1,0,1,0,1],
  [1,0,0,0,0,1,0,0,0,1,0,1,0,1],
  [1,1,1,1,0,1,1,1,1,1,0,2,0,1],
  [1,1,1,1,1,1,1,1,1,1,1,1,1,1]
];


    
    function getMazeAndTime() {
      const difficulty = document.getElementById('difficulty').value;
      if (difficulty === 'easy') return { data: easyMaze, time: 50 };
      if (difficulty === 'medium') return { data: mediumMaze, time: 40 };
      if (difficulty === 'hard') return { data: hardMaze, time: 30 };
    }
    
    function renderMaze() {
      maze.innerHTML = '';
      for (let y = 0; y < mazeData.length; y++) {
        for (let x = 0; x < mazeData[y].length; x++) {
          const cell = document.createElement('div');
          cell.classList.add('cell');
          if (mazeData[y][x] === 1) cell.classList.add('wall');
          if (mazeData[y][x] === 2) cell.classList.add('goal');
          if (mazeData[y][x] === 3) cell.classList.add('obstacle');
          if (mazeData[y][x] === 4) cell.classList.add('shield');
          if (playerPos.x === x && playerPos.y === y) cell.classList.add('player');
          maze.appendChild(cell);
        }
      }
    }
    
    function updateStats() {
      document.getElementById('score').innerText = score;
      document.getElementById('shields').innerText = shields;
      document.getElementById('timer').innerText = timeLeft;
    }
    
    function movePlayer(dx, dy) {
      const newX = playerPos.x + dx;
      const newY = playerPos.y + dy;
      const target = mazeData[newY][newX];
    
      if (target !== 1) {
        if (target === 3) {
          if (shields > 0) {
            shields--;
            wallSound?.play()
            alert("üõ°Ô∏è Shield used! You are safe.");
          } else {
            score -= 10;
            timeLeft -= 5;
            alert("üö´ Obstacle! -10 points, -5 sec.");
          }
        } else if (target === 4) {
          shields++;
          mazeData[newY][newX] = 0;
          shieldsound?.play();
          alert("‚ú® Shield Collected! +1 shield.");
        } else {
          score += 5;
        }
    
        playerPos = { x: newX, y: newY };
        updateStats();
        renderMaze();
    
        if (target === 2) {
          clearInterval(timerInterval);
          winSound?.play();
          setTimeout(() => {
            alert(`‚úÖ you won ü•≥ü•≥ üèÅ Goal reached!\nScore: ${score}`);
            updateLeaderboard(score);
          }, 200);
        }
    
        moveSound?.play();
      } else {
        wallSound?.play();
      }
    }
    
    function buyShield() {
      if (score >= 20) {
        score -= 20;
        shields++;
        alert("üõ°Ô∏è Shield bought! -20 points.");
        updateStats();
      } else {
        alert("‚ùå Not enough points to buy a shield.");
      }
    
  }

  function displayGameBoard() {
  initSounds();
  const { data, time } = getMazeAndTime();
  mazeData = data.map(row => [...row]);
  timeLeft = time;
  const totalTime = time; // Store total time for progress calculation
  score = 0;
  shields = 1;
  playerPos = { x: 1, y: 1 };
  updateStats();
  renderMaze();

  // Reset progress bar
  const timerFill = document.getElementById('timer-fill');
  timerFill.style.width = '100%';
  timerFill.style.backgroundColor = 'limegreen';

  clearInterval(timerInterval);
  timerInterval = setInterval(() => {
    timeLeft--;
    document.getElementById('timer').innerText = timeLeft;

    // Update progress bar width
    const percentage = (timeLeft / totalTime) * 100;
    timerFill.style.width = percentage + '%';

    // Optional: Change color based on time left
    if (percentage <= 25) {
      timerFill.style.backgroundColor = 'red';
    } else if (percentage <= 50) {
      timerFill.style.backgroundColor = 'orange';
    } else {
      timerFill.style.backgroundColor = 'limegreen';
    }

    if (timeLeft <= 0) {
      clearInterval(timerInterval);
      alert(`‚è∞ Time's up!\n‚ùå you Lost\nScore: ${score}`);
      updateLeaderboard(score);
    }
  }, 1000);
}

  function startGame() {
  initSounds();
  const { data, time } = getMazeAndTime();
  mazeData = data.map(row => [...row]);
  timeLeft = time;
  const totalTime = time; // Store total time for progress calculation
  score = 0;
  shields = 1;
  playerPos = { x: 1, y: 1 };
  updateStats();
  renderMaze();

  // Reset progress bar
  const timerFill = document.getElementById('timer-fill');
  timerFill.style.width = '100%';
  timerFill.style.backgroundColor = 'limegreen';

  clearInterval(timerInterval);
  timerInterval = setInterval(() => {
    timeLeft--;
    document.getElementById('timer').innerText = timeLeft;

    // Update progress bar width
    const percentage = (timeLeft / totalTime) * 100;
    timerFill.style.width = percentage + '%';

    // Optional: Change color based on time left
    if (percentage <= 25) {
      timerFill.style.backgroundColor = 'red';
    } else if (percentage <= 50) {
      timerFill.style.backgroundColor = 'orange';
    } else {
      timerFill.style.backgroundColor = 'limegreen';
    }

    if (timeLeft <= 15) {
    timerSound.play();
    timerSound.play();
  }

    if (timeLeft <= 0) {
      clearInterval(timerInterval);
      alert(`‚è∞ Time's up!\nScore: ${score}`);
      updateLeaderboard(score);
    }
  }, 1000);

  // Fetch predefined moves from Flask backend
  fetch('/start_game', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ difficulty: document.getElementById('difficulty').value })
  })
  .then(response => response.json())
  .then(data => {
    if (data.status === 'ready') {
      console.log("Game ready, starting the first move");
      fetchNextMove();  // Start moving step-by-step
    }
  });
}

function fetchNextMove() {
  fetch('/next_move', {
    method: 'POST'
  })
  .then(response => response.json())
  .then(data => {
    if (data.status === "done") {
      console.log("üéâ All moves done");
      return;
    }

    const { mental_state, move } = data;

    switch (mental_state) {
      case "Concentrated":
        console.log(`üß† ${mental_state}: Performing move ${move}`);
        applyMove(move);
        // alert(`üß† Action detected. Performing move: ${move}.`);
        break;

      case "Relaxed":
        alert("üßò You're relaxed. Try focusing more to proceed.");
        break;

      case "Stressed":
        alert("‚ö†Ô∏è You're stressed. Take a deep breath before continuing.");
        break;

      default:
        alert("Unknown state. Please try again.");
    }

    if (!(timeLeft <= 0)) {
      setTimeout(fetchNextMove, 1500);
    }

  });
}


function applyMove(move) {
  console.log("Applying move:", move);
  switch (move) {
    case 'left': movePlayer(-1, 0); break;
    case 'right': movePlayer(1, 0);  break;
    case 'up': movePlayer(0, -1);  break;
    case 'down': movePlayer(0, 1);  break;
  }
}


    
    function showHelp() {
      alert("üîºüîΩ‚óÄÔ∏è‚ñ∂Ô∏è Use arrow keys to move.\nüõ°Ô∏è Avoid or use shield on obstacles.\n‚ú® Collect shield bonuses.\nüèÅ Reach the goal before time runs out.");
    }
    
    // Keep an array to track all players and their scores
let playerScores = [];

function updateLeaderboard(finalScore) {
  // Add the new score
  playerScores.push({ name: 'Neuroplayer', score: finalScore });

  // Sort the array in descending order by score
  playerScores.sort((a, b) => b.score - a.score);

  // Get the top 3 players
  const topThree = playerScores.slice(0, 3);


  const leaderboard = document.querySelector('.leaderboard');

   // Select the leaderboard container
   if (leaderboard) {
  leaderboard.innerHTML = '<h2>Leaderboard</h2>';
  // ...
}

 // Trophy image filenames for 1st, 2nd, 3rd
 const trophies = [
    "{{ url_for('static', filename='images/gold.png') }}",
    "{{ url_for('static', filename='images/silver.png') }}",
    "{{ url_for('static', filename='images/bronze.png') }}"
  ];

// Add top 3 players with respective trophies
topThree.forEach((player, index) => {
  const playerDiv = document.createElement('div');
  playerDiv.className = 'playerlead';
  playerDiv.innerHTML = `
    <img src="${trophies[index]}" alt="Rank ${index + 1}">
    <span> Rank ${index + 1} - ${player.name} - ${player.score} </span>
  `;
  leaderboard.appendChild(playerDiv);
});
}
    
    document.addEventListener('keydown', e => {
      switch (e.key) {
        case 'ArrowUp': movePlayer(0, -1); break;
        case 'ArrowDown': movePlayer(0, 1); break;
        case 'ArrowLeft': movePlayer(-1, 0); break;
        case 'ArrowRight': movePlayer(1, 0); break;
      }
    });

    function reloadPage() {
            location.reload();
        }

        function goToDashboard() {
            window.location.href = "{{ url_for('dashboard') }}";
        }


    const flashDiv = document.getElementById('flash-data');
    const message = flashDiv.dataset.message;
    if (message) {
      alert(message);
    }
    
    window.onload = () => {
      displayGameBoard();
};
    </script>
    
</body>
</html>
